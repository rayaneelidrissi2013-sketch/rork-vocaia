<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration SQL - VocaIA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .instructions {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .instructions h3 {
            color: #1565c0;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #333;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .sql-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 25px;
            position: relative;
            margin-bottom: 20px;
        }
        
        .sql-code {
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .copy-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .copy-btn:active {
            transform: translateY(0);
        }
        
        .copy-btn.copied {
            background: #2196f3;
        }
        
        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        .warning-icon {
            color: #ffc107;
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .warning-content {
            color: #856404;
        }
        
        .warning-content h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .warning-content ul {
            margin-left: 20px;
        }
        
        .warning-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üóÑÔ∏è</span>
            Migration SQL - VocaIA
        </h1>
        <p class="subtitle">
            Copiez et collez ce code SQL directement dans votre console PostgreSQL (Supabase SQL Editor).
        </p>
        
        <div class="instructions">
            <h3>üìã Instructions :</h3>
            <ol>
                <li>Connectez-vous √† votre <strong>Supabase Dashboard</strong></li>
                <li>Allez dans <strong>SQL Editor</strong> (dans le menu de gauche)</li>
                <li>Cliquez sur <strong>"New Query"</strong></li>
                <li>Cliquez sur le bouton <strong>"üìã Copier le SQL"</strong> ci-dessous</li>
                <li>Collez le code SQL dans l'√©diteur Supabase</li>
                <li>Cliquez sur <strong>"Run"</strong> pour ex√©cuter la migration</li>
                <li>Attendez que l'ex√©cution se termine (quelques secondes)</li>
                <li>V√©rifiez que toutes les tables ont √©t√© cr√©√©es dans l'onglet <strong>"Table Editor"</strong></li>
            </ol>
        </div>
        
        <div class="sql-container">
            <button class="copy-btn" onclick="copySQL()">üìã Copier le SQL</button>
            <div class="sql-code" id="sqlCode">-- VocaIA PostgreSQL Database Schema
-- Ce fichier contient le sch√©ma complet de la base de donn√©es pour VocaIA

-- Extension pour g√©n√©rer des UUIDs
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Table des utilisateurs
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  phone_number VARCHAR(50) NOT NULL,
  language VARCHAR(10) DEFAULT 'fr',
  timezone VARCHAR(50) DEFAULT 'Europe/Paris',
  role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin')),
  
  -- Int√©gration Vapi.ai
  vapi_agent_id VARCHAR(255),
  vapi_phone_number VARCHAR(50),
  user_personal_phone VARCHAR(50),
  is_agent_active BOOLEAN DEFAULT FALSE,
  custom_prompt_template TEXT,
  profession VARCHAR(100),
  
  -- Abonnement et facturation
  plan_id VARCHAR(50),
  minutes_included INTEGER DEFAULT 0,
  minutes_remaining INTEGER DEFAULT 0,
  minutes_consumed INTEGER DEFAULT 0,
  date_renouvellement TIMESTAMP,
  
  -- Parrainage
  referral_code VARCHAR(50) UNIQUE,
  referred_by_code VARCHAR(50),
  bonus_minutes INTEGER DEFAULT 0,
  referral_count INTEGER DEFAULT 0,
  
  -- M√©tadonn√©es
  registration_date TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des appels
CREATE TABLE IF NOT EXISTS calls (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  vapi_call_id VARCHAR(255),
  
  -- Informations de l'appelant
  caller_name VARCHAR(255),
  caller_number VARCHAR(50) NOT NULL,
  
  -- D√©tails de l'appel
  timestamp TIMESTAMP DEFAULT NOW(),
  duration INTEGER DEFAULT 0,
  duration_seconds INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'completed' CHECK (status IN ('completed', 'missed', 'ongoing')),
  
  -- Contenu de l'appel
  summary TEXT,
  transcription TEXT,
  audio_url TEXT,
  gcs_recording_url TEXT,
  
  -- Co√ªt Vapi.ai
  vapi_cost DECIMAL(10, 4) DEFAULT 0,
  
  -- M√©tadonn√©es
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des plannings d'activation AI
CREATE TABLE IF NOT EXISTS schedules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  day_of_week INTEGER NOT NULL CHECK (day_of_week BETWEEN 0 AND 6),
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  enabled BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, day_of_week)
);

-- Table des cl√©s API (pour l'administrateur)
CREATE TABLE IF NOT EXISTS api_keys (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  key_name VARCHAR(100) UNIQUE NOT NULL,
  key_value TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des num√©ros virtuels
CREATE TABLE IF NOT EXISTS virtual_numbers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  phone_number VARCHAR(50) UNIQUE NOT NULL,
  country VARCHAR(100) NOT NULL,
  country_code VARCHAR(10) NOT NULL,
  provider VARCHAR(50) NOT NULL,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive')),
  assigned_user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  webhook_url TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des param√®tres globaux
CREATE TABLE IF NOT EXISTS global_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  setting_key VARCHAR(100) UNIQUE NOT NULL,
  setting_value TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des plans d'abonnement
CREATE TABLE IF NOT EXISTS subscription_plans (
  id VARCHAR(50) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  minutes_included INTEGER NOT NULL,
  price DECIMAL(10, 2) NOT NULL,
  features JSONB,
  is_recommended BOOLEAN DEFAULT FALSE,
  overage_policy VARCHAR(20) DEFAULT 'charge' CHECK (overage_policy IN ('upgrade', 'charge')),
  overage_rate DECIMAL(10, 2) DEFAULT 0.55,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des paiements
CREATE TABLE IF NOT EXISTS payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  amount DECIMAL(10, 2) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('subscription', 'overage')),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('completed', 'pending', 'failed')),
  paypal_transaction_id VARCHAR(255),
  date TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table des abonnements utilisateurs
CREATE TABLE IF NOT EXISTS user_subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  plan_id VARCHAR(50) NOT NULL REFERENCES subscription_plans(id),
  paypal_subscription_id VARCHAR(255),
  minutes_used INTEGER DEFAULT 0,
  minutes_remaining INTEGER DEFAULT 0,
  start_date TIMESTAMP DEFAULT NOW(),
  renewal_date TIMESTAMP,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'expired', 'cancelled', 'suspended')),
  payment_method VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Table de v√©rification SMS (temporaire)
CREATE TABLE IF NOT EXISTS sms_verifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  phone_number VARCHAR(50) NOT NULL,
  code VARCHAR(10) NOT NULL,
  verified BOOLEAN DEFAULT FALSE,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Index pour am√©liorer les performances
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
CREATE INDEX IF NOT EXISTS idx_users_vapi_phone_number ON users(vapi_phone_number);
CREATE INDEX IF NOT EXISTS idx_calls_user_id ON calls(user_id);
CREATE INDEX IF NOT EXISTS idx_calls_timestamp ON calls(timestamp);
CREATE INDEX IF NOT EXISTS idx_calls_vapi_call_id ON calls(vapi_call_id);
CREATE INDEX IF NOT EXISTS idx_schedules_user_id ON schedules(user_id);
CREATE INDEX IF NOT EXISTS idx_virtual_numbers_assigned_user_id ON virtual_numbers(assigned_user_id);
CREATE INDEX IF NOT EXISTS idx_payments_user_id ON payments(user_id);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_sms_verifications_phone ON sms_verifications(phone_number);
CREATE INDEX IF NOT EXISTS idx_sms_verifications_expires ON sms_verifications(expires_at);

-- Fonction pour mettre √† jour automatiquement updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- Triggers pour updated_at
DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_calls_updated_at ON calls;
CREATE TRIGGER update_calls_updated_at BEFORE UPDATE ON calls
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_schedules_updated_at ON schedules;
CREATE TRIGGER update_schedules_updated_at BEFORE UPDATE ON schedules
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_api_keys_updated_at ON api_keys;
CREATE TRIGGER update_api_keys_updated_at BEFORE UPDATE ON api_keys
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_virtual_numbers_updated_at ON virtual_numbers;
CREATE TRIGGER update_virtual_numbers_updated_at BEFORE UPDATE ON virtual_numbers
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_global_settings_updated_at ON global_settings;
CREATE TRIGGER update_global_settings_updated_at BEFORE UPDATE ON global_settings
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_subscription_plans_updated_at ON subscription_plans;
CREATE TRIGGER update_subscription_plans_updated_at BEFORE UPDATE ON subscription_plans
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_payments_updated_at ON payments;
CREATE TRIGGER update_payments_updated_at BEFORE UPDATE ON payments
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_user_subscriptions_updated_at ON user_subscriptions;
CREATE TRIGGER update_user_subscriptions_updated_at BEFORE UPDATE ON user_subscriptions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Insertion des plans d'abonnement par d√©faut
INSERT INTO subscription_plans (id, name, minutes_included, price, features, is_recommended, overage_policy)
VALUES
  ('gratuit', 'Pack Gratuit', 5, 0.00, 
   '["Assistant vocal IA 24H/7J", "Retranscription de tous vos appels"]'::jsonb, 
   FALSE, 'upgrade'),
  ('decouverte', 'Pack D√©couverte', 100, 35.00, 
   '["Assistant vocal IA 24H/7J", "Retranscription de tous vos appels"]'::jsonb, 
   FALSE, 'upgrade'),
  ('standard', 'Pack Standard', 300, 90.00, 
   '["Assistant vocal IA 24H/7J", "Retranscription de tous vos appels"]'::jsonb, 
   TRUE, 'upgrade'),
  ('pro', 'Pack Pro', 1200, 300.00, 
   '["Assistant vocal IA 24H/7J", "Retranscription de tous vos appels"]'::jsonb, 
   FALSE, 'upgrade'),
  ('entreprise', 'Pack Entreprise', 99999, 0.00, 
   '["750+ minutes d''appels IA/mois", "Fonctionnement 24h/24 et 7j/7", "Z√©ro charge salariale", "Solutions sur-mesure", "Agents IA Multilingues", "Account Manager d√©di√©", "Support prioritaire 24/7", "Tarification sur mesure", "√âvolutivit√© instantan√©e", "Rapports d√©taill√©s"]'::jsonb, 
   FALSE, 'upgrade')
ON CONFLICT (id) DO NOTHING;

-- Insertion des param√®tres globaux par d√©faut
INSERT INTO global_settings (setting_key, setting_value, description)
VALUES
  ('default_prompt', 'Bonjour, je suis l''assistant virtuel. Je ne suis pas disponible pour le moment. Comment puis-je vous aider ?', 'Prompt par d√©faut pour les nouveaux utilisateurs'),
  ('default_language', 'fr', 'Langue par d√©faut'),
  ('default_temperature', '0.5', 'Temp√©rature par d√©faut pour l''IA'),
  ('default_max_tokens', '250', 'Nombre maximum de tokens par d√©faut'),
  ('default_voice_type', 'female', 'Type de voix par d√©faut'),
  ('overage_rate', '0.55', 'Tarif par minute en d√©passement ($)'),
  ('allowed_countries', '["+1"]', 'Liste des codes pays autoris√©s pour l''inscription (format JSON array)')
ON CONFLICT (setting_key) DO NOTHING;

-- Cr√©ation de l'utilisateur administrateur par d√©faut
-- Mot de passe par d√©faut: "admin123" (√† changer imm√©diatement en production)
INSERT INTO users (email, password_hash, name, phone_number, role, registration_date)
VALUES
  ('tawfikelidrissi@gmail.com', '$2b$10$BnMLy3YWxZHCnC3UnKKy.eC0YNaM2EFE4cGVj9cLhiQZ8PmC.nYru', 'Administrateur', '+212600000000', 'admin', NOW())
ON CONFLICT (email) DO NOTHING;
</div>
        </div>
        
        <div class="warning">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-content">
                <h3>Important :</h3>
                <ul>
                    <li><strong>Compte Admin cr√©√© :</strong> Email = <code>tawfikelidrissi@gmail.com</code>, Mot de passe = <code>admin123</code></li>
                    <li><strong>Changez le mot de passe admin imm√©diatement en production !</strong></li>
                    <li>Cette migration est idempotente : vous pouvez l'ex√©cuter plusieurs fois sans probl√®me</li>
                    <li>Toutes les donn√©es existantes seront pr√©serv√©es (ON CONFLICT DO NOTHING)</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        function copySQL() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            const btn = document.querySelector('.copy-btn');
            
            navigator.clipboard.writeText(sqlCode).then(() => {
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copi√© !';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('Erreur lors de la copie : ' + err);
            });
        }
    </script>
</body>
</html>
